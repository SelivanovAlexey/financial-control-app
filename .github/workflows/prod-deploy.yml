name: Production Pipeline

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'What to deploy?'
        required: true
        default: 'both'
        type: choice
        options:
          - backend
          - frontend
          - both

env:
  REGISTRY: ghcr.io

jobs:
  backend-prod:
    name: Backend Prod Build & Deploy
    if: ${{ github.event.inputs.target == 'backend' || github.event.inputs.target == 'both' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare Image Names
        run: |
          echo "BACKEND_IMAGE=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')/financial-backend" >> $GITHUB_ENV
          echo "FRONTEND_IMAGE=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')/financial-frontend" >> $GITHUB_ENV

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Maven Test & Package
        run: |
          cd backend
          mvn clean package

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:prod
            ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }}

      - name: Deploy to Northflank
        uses: northflank/deploy-to-northflank@v1
        with:
          northflank-api-key: ${{ secrets.NORTHFLANK_API_TOKEN }}
          project-id: ${{ secrets.NORTHFLANK_PROJECT_ID }}
          service-id: ${{ secrets.NORTHFLANK_SERVICE_ID_PROD }}
          image-path: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }}

  frontend-prod:
    name: Frontend Prod Build & Deploy
    if: ${{ github.event.inputs.target == 'frontend' || github.event.inputs.target == 'both' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare Image Names
        run: |
          echo "BACKEND_IMAGE=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')/financial-backend" >> $GITHUB_ENV
          echo "FRONTEND_IMAGE=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')/financial-frontend" >> $GITHUB_ENV

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: NPM install and build
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:prod
            ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }}

      - name: Trigger Render deploy
        env:
          deploy_url: ${{ secrets.RENDER_DEPLOY_HOOK_URL_PROD }}
        run: |
          curl "$deploy_url"
